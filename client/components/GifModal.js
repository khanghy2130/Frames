// viewing a gif, showing collections to add to
// get current user's collections data everytime this component renders
// shown when open a gif from search results (/explore) or from collection modals

import axios from "axios";
import { useState, useEffect, Fragment } from 'react';
import ReactImageFallback from 'react-image-fallback';

import spinnerImage from '../images/spinner.gif';


export default ({ gifObj, setGifObj, setAlertMessage, userContext }) => {
	if (!gifObj) return (null); // closed state

	const closeGifModal = () => { setGifObj(null) };

	// GOAL: get collections data before showing modal
	const [collections, setCollections] = useState(null);

	useEffect(() => {
		// authenticated ?
		if (userContext){
			(async function(){
				console.log("sending request"); ///////////// keep track of when it sends
				const result = await axios.get('/get_my_collections');

				// error occurred
				if (result.data.err_message){
					setAlertMessage(result.data.err_message);
					return closeGifModal(); // end this function
				}

				// data fetched
				setCollections(result.data.collections);
			})()
		}
			
	}, []);


	// render this if still fetching collections data
	if (!collections && userContext) return (
		<div id="gif-modal-loading">
			Loading...
		</div>
	);

	const addGif = collection => {
		// update UI for this collection item
		setCollections(collections.map(c => {
			if (c === collection){
				c.gifs.push({}); // push a dummy item to bump up the length
				c.added = true;
				return c;
			}
			else return c;
		}));
	};

	const createCollection = () => {
		console.log("creating collection, and wait!"); /////////
	};

	return (
		<div id="gif-modal">
			<div id="gif-modal-content">

				<div className="close-button-div">
					<button onClick={closeGifModal}>
						<i className="fas fa-times" />&nbsp;Close
					</button>
				</div>

				<div id="gif-info">
					<h1>{gifObj.title}</h1>
					<ReactImageFallback 
						src={gifObj.url}
						initialImage={spinnerImage}
						fallbackImage={spinnerImage}
					/>
				</div>

				<div id="add-to-collections-div">
					{	
						// not logged in?
						(!userContext) ? (
							<p id="not-logged-in">
								<a href='/login'>Log in</a> to start collecting.
							</p>
						) : (<Fragment>
								{collections.map(c => (
									<div className="add-collection-item"
									key={c._id}>
										<h3>
											{ 
												// render visibility icon
												<i className={
													[
														'fas fa-lock',
														'fas fa-user-friends',
														'fas fa-globe'
													][c.visibility]
												}/>
											}

											&nbsp;&nbsp;
											{ `${c.title} (${c.gifs.length})` }
										</h3>
										{
											(!c.added) ? (
												<button className="enabled-btn"
												onClick={ () => {addGif(c)} }>
													Add
												</button>
											) : (
												<button disabled>
													Added
												</button>
											)
										}
										
									</div>
								))}

								<button id="create-collection-btn"
								onClick={createCollection}>
									Create new collection
								</button>
							</Fragment>
						)
					}
				</div>

			</div>
		</div>
	);
	
};